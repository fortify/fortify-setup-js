spec:
  inputs:
    sc-client:
      default: ''
      description: 'ScanCentral Client version to install (e.g., latest, 24.4.0, auto, skip)'
    fcli:
      default: 'latest'
      description: 'fcli version to install (e.g., latest, auto, skip)'
    fod-uploader:
      default: ''
      description: 'FoD Uploader version to install'
    debricked-cli:
      default: ''
      description: 'Debricked CLI version to install'
    export-path:
      default: 'true'
      description: 'Add installed tools to PATH'
    use-tool-cache:
      default: 'false'
      description: 'Use GitLab tool cache for installed tools'
---

# Fortify Setup Component
# Install Fortify tools in GitLab CI pipelines

fortify-setup:
  image: node:20-alpine
  script:
    - |
      echo "Installing @fortify/setup..."
      npm install -g @fortify/setup
      
      echo "Setting up Fortify tools..."
      
      # Build tools list
      TOOLS=""
      
      if [ -n "$[[ inputs.fcli ]]" ]; then
        TOOLS="fcli:$[[ inputs.fcli ]]"
      fi
      
      if [ -n "$[[ inputs.sc-client ]]" ]; then
        [ -n "$TOOLS" ] && TOOLS="$TOOLS,"
        TOOLS="${TOOLS}sc-client:$[[ inputs.sc-client ]]"
      fi
      
      if [ -n "$[[ inputs.fod-uploader ]]" ]; then
        [ -n "$TOOLS" ] && TOOLS="$TOOLS,"
        TOOLS="${TOOLS}fod-uploader:$[[ inputs.fod-uploader ]]"
      fi
      
      if [ -n "$[[ inputs.debricked-cli ]]" ]; then
        [ -n "$TOOLS" ] && TOOLS="$TOOLS,"
        TOOLS="${TOOLS}debricked-cli:$[[ inputs.debricked-cli ]]"
      fi
      
      # Disable fcli caching in CI
      export FCLI_CACHE_ENABLED=false
      
      # Run fortify-setup env init
      if [ -n "$TOOLS" ]; then
        fortify-setup env init --tools "$TOOLS"
      fi
      
      # Generate environment variables for downstream jobs
      echo "Generating environment variables..."
      fortify-setup env gitlab > fortify-tools.env
      
      echo "âœ“ Fortify tools setup complete"
  
  artifacts:
    reports:
      dotenv: fortify-tools.env
